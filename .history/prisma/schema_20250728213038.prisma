// Migration to fix database schema inconsistencies
// Run this to ensure all your routes work properly

// 1. Update schema.prisma to use consistent session.shop approach
model ShopSettings {
  id                      Int      @id @default(autoincrement())
  shopId                  String   @unique  // This should match session.shop format
  formFields              String?  @default("[]")
  formStyle               String?  @default("{}")
  shippingRates           String?  @default("[]")
  pixelSettings           String?  @default("{}")
  visibilityMode          String?  @default("both_cart_product")
  visibleProducts         String?  @default("[]")
  hiddenProducts          String?  @default("[]")
  allowedCountries        String?  @default("[]")
  hideAddToCart           Boolean  @default(false)
  hideBuyNow              Boolean  @default(false)
  disableOnHome           Boolean  @default(false)
  disableOnCollections    Boolean  @default(false)
  enableSpecificProducts  Boolean  @default(false)
  disableSpecificProducts Boolean  @default(false)
  enableSpecificCountries Boolean  @default(false)
  minimumAmount           String?  @default("")
  maximumAmount           String?  @default("")
  googleAccessToken       String?
  googleRefreshToken      String?
  googleUserEmail         String?
  googleSheetId           String?
  googleSheetName         String?
  googleSheetTabName      String?
  googleSheetImportOrders Boolean  @default(true)
  googleSheetImportLines  Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  generalSettings         String?
  userBlocking            String?
  Session                 Session  @relation(fields: [shopId], references: [shop], onDelete: Cascade)

  @@index([shopId])
}

// 2. Update Session model to use shop as identifier
model Session {
  id            String        @id
  shop          String        @unique  // This is the main identifier
  state         String
  isOnline      Boolean       @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  accountOwner  Boolean?
  collaborator  Boolean?
  email         String?
  emailVerified Boolean?
  firstName     String?
  lastName      String?
  locale        String?
  ShopSettings  ShopSettings?
  
  @@index([shop])
}

// 3. Update OrderTracking to use proper indices
model OrderTracking {
  id                   String   @id @default(cuid())
  shopId               String   // Should match session.shop
  draftOrderId         String
  customerIp           String?
  customerEmail        String?
  customerPhone        String?
  customerPostalCode   String?
  totalQuantity        Int
  orderTotal           Float
  currency             String
  createdAt            DateTime @default(now())

  @@index([shopId])
  @@index([customerEmail])
  @@index([customerPhone])
  @@index([customerIp])
  @@index([createdAt])
}