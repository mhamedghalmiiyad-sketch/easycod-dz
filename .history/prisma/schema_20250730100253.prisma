// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../dev.sqlite"
}

model ShopSettings {
  id                      Int      @id @default(autoincrement())
  shopId                  String   @unique // This should match session.shop
  formFields              String?  @default("[]")
  formStyle               String?  @default("{}")
  shippingRates           String?  @default("[]")
  pixelSettings           String?  @default("{}")
  visibilityMode          String?  @default("both_cart_product")
  visibleProducts         String?  @default("[]")
  hiddenProducts          String?  @default("[]")
  allowedCountries        String?  @default("[]")
  hideAddToCart           Boolean  @default(false)
  hideBuyNow              Boolean  @default(false)
  disableOnHome           Boolean  @default(false)
  disableOnCollections    Boolean  @default(false)
  enableSpecificProducts  Boolean  @default(false)
  disableSpecificProducts Boolean  @default(false)
  enableSpecificCountries Boolean  @default(false)
  minimumAmount           String?  @default("")
  maximumAmount           String?  @default("")
  googleAccessToken       String?
  googleRefreshToken      String?
  googleUserEmail         String?
  googleSheetId           String?
  googleSheetName         String?
  googleSheetTabName      String?
  googleSheetImportOrders Boolean  @default(true)
  googleSheetImportLines  Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  generalSettings         String?
  userBlocking            String?
  Session                 Session? @relation(fields: [shopId], references: [shop], onDelete: Cascade)

  @@index([shopId])
}

model Session {
  id               String          @id
  shop             String          @unique // This is the main identifier
  state            String
  isOnline         Boolean         @default(false)
  scope            String?
  expires          DateTime?
  accessToken      String
  userId           BigInt?
  accountOwner     Boolean?
  collaborator     Boolean?
  email            String?
  emailVerified    Boolean?
  firstName        String?
  lastName         String?
  locale           String?
  ShopSettings     ShopSettings?
  AppProxy         AppProxy?
  OrderTrackings   OrderTracking[]
  AbandonedCarts   AbandonedCart[] // Added the back-relation for AbandonedCart

  @@index([shop])
}

model AppProxy {
  id            Int      @id @default(autoincrement())
  shopId        String   @unique
  isEnabled     Boolean  @default(true)
  configuration String?  @default("{}")
  Session       Session  @relation(fields: [shopId], references: [shop], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([shopId])
}

model OrderTracking {
  id                 String   @id @default(cuid())
  shopId             String
  draftOrderId       String
  customerIp         String?
  customerEmail      String?
  customerPhone      String?
  customerPostalCode String?
  totalQuantity      Int
  orderTotal         Float
  currency           String
  createdAt          DateTime @default(now())
  Session            Session  @relation(fields: [shopId], references: [shop], onDelete: Cascade)

  @@index([shopId])
  @@index([customerEmail])
  @@index([customerPhone])
  @@index([customerIp])
  @@index([createdAt])
}

// New model for tracking abandoned carts
model AbandonedCart {
  id              String    @id @default(cuid())
  shopId          String
  sessionId       String    @unique
  customerEmail   String?
  customerPhone   String?
  customerName    String?
  cartData        String // JSON string of cart items
  formData        String? // JSON string of partial form data
  abandonedAt     DateTime  @default(now())
  lastReminderAt  DateTime?
  reminderCount   Int       @default(0)
  isRecovered     Boolean   @default(false)
  recoveredAt     DateTime?
  recoveryOrderId String?
  Session         Session   @relation(fields: [shopId], references: [shop], onDelete: Cascade)

  @@index([shopId])
  @@index([customerEmail])
  @@index([abandonedAt])
  @@index([isRecovered])
}